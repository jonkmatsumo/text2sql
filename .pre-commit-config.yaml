repos:
  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-json
      - id: check-toml
      - id: check-added-large-files
        args: ["--maxkb=1000"]
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: mixed-line-ending
        args: ["--fix=lf"]

  # Python code formatting
  - repo: https://github.com/psf/black
    rev: 24.2.0
    hooks:
      - id: black
        language_version: python3.12
        args: ["--line-length=100"]

  # Python linting
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        args: ["--max-line-length=100", "--extend-ignore=E203,W503,D100"]
        additional_dependencies: [flake8-docstrings]

  # Python import sorting
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: ["--profile", "black", "--line-length=100"]

  # YAML formatting
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        types: [yaml]
        exclude: ^docker-compose\.yml

  # Dockerfile linting
  # Note: Hadolint hook removed because it requires Docker daemon to be running.
  # Dockerfile linting is handled in CI/CD pipeline instead (see .github/workflows/ci.yml).
  # To lint Dockerfiles locally when Docker is running, use:
  #   docker run --rm -i hadolint/hadolint < Dockerfile

  # Pytest - validate test collection with importlib mode (required for multi-directory tests)
  # This hook ensures pytest can collect tests correctly when running from root directory
  - repo: local
    hooks:
      - id: pytest-check
        name: pytest-check (test collection validation)
        entry: bash
        language: system
        types: [python]
        args:
          - -c
          - |
            # Check if pytest is available
            if ! command -v pytest > /dev/null 2>&1; then
              echo "⚠ pytest not found, skipping test collection validation"
              exit 0
            fi

            # Check if any test files are staged or changed
            changed_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || echo "")
            if [ -z "$changed_files" ]; then
              changed_files=$(git diff --name-only --diff-filter=ACM 2>/dev/null || echo "")
            fi

            # Check if any test files changed
            if echo "$changed_files" | grep -qE "(test_|tests/|conftest\.py|pytest\.ini)"; then
              echo "Test files changed, validating pytest collection..."
              # Validate that pytest can collect tests with importlib mode
              # Suppress output but capture errors
              if ! pytest --import-mode=importlib --collect-only -q 2>&1 | grep -v "collected" > /dev/null 2>&1; then
                # If collection fails, check if it's due to missing dependencies
                collection_output=$(pytest --import-mode=importlib --collect-only -q 2>&1)
                if echo "$collection_output" | grep -q "ModuleNotFoundError\|ImportError"; then
                  echo "⚠ pytest dependencies not installed, skipping validation"
                  echo "   Install dependencies: cd mcp-server && pip install -e '.[test]'"
                  exit 0
                else
                  echo "❌ pytest test collection failed with --import-mode=importlib"
                  echo "   This is required when collecting tests from multiple directories."
                  echo "   Run 'pytest --import-mode=importlib --collect-only' to debug."
                  exit 1
                fi
              fi
              echo "✓ pytest test collection validated"
            else
              echo "No test files changed, skipping pytest validation"
            fi
        pass_filenames: false
        always_run: false
