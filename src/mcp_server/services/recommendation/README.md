# Recommendation Service Configuration

The Recommendation Service uses environment variables to behave dynamically without code changes.

## Environment Variables

| Variable | Default | Description |
|---|---|---|
| `RECO_LIMIT_DEFAULT` | 3 | Default number of examples to recommend if not specified. |
| `RECO_CANDIDATE_MULTIPLIER` | 2 | Multiplier for fetching candidates (e.g., `limit * multiplier`). |
| `RECO_FALLBACK_ENABLED` | true | Enable/disable fallback to interaction history. |
| `RECO_FALLBACK_THRESHOLD` | 0.85 | Similarity threshold for fallback candidates. |
| `RECO_STATUS_PRIORITY` | `verified, seeded, autogenerated, unverified` | Comma-separated list of status priorities (first = highest). |

## Examples

**Increase candidate pool for better diversity:**
```bash
RECO_CANDIDATE_MULTIPLIER=5
```

**Disable fallback entirely:**
```bash
RECO_FALLBACK_ENABLED=false
```

**Prioritize seeded examples over verified:**
```bash
RECO_STATUS_PRIORITY=seeded,verified
```

## Diversity Guarantees

When diversity is enabled (`RECO_DIVERSITY_ENABLED=true`), the service provides several best-effort guarantees for the selection mix:

### Guarantees
- **Minimum Verified Floor**: The engine ensures at least `RECO_DIVERSITY_MIN_VERIFIED` (default: 1) examples are sourced from the `verified` (approved) status, regardless of their similarity ranking, provided enough candidates exist.
- **Source Capping**: No single source (approved, seeded, or fallback) will ever exceed `RECO_DIVERSITY_MAX_PER_SOURCE` (default: -1, meaning uncapped) to prevent source domination.
- **Fingerprint Uniqueness**: Even with diversity enabled, the service **always** enforces fingerprint deduplication. You will never see two examples from the same canonical group (duplicate SQL structure) in a single recommendation result.
- **Deterministic Selection**: For a stable candidate pool, the selection results are deterministic based on the input similarity ranking.

### Non-Guarantees / Out of Scope
- **SQL Structure Diversity**: We do **not** current guarantee diversity in SQL logic beyond group deduplication.
- **Global Optimality**: Diversity floors may pull a less similar verified example in place of a more similar seeded one to satisfy the contract.
- **Stable Ordering on Ties**: Tie-breaking on identical similarity scores is not explicitly stable.

### Related Configs
- `RECO_DIVERSITY_ENABLED`: Main toggle (default: false).
- `RECO_DIVERSITY_MIN_VERIFIED`: Minimum number of verified examples.
- `RECO_DIVERSITY_MAX_PER_SOURCE`: Maximum examples per status source.
