-- Golden Dataset table for regression testing
CREATE TABLE IF NOT EXISTS public.golden_dataset (
    test_id SERIAL PRIMARY KEY,
    question TEXT NOT NULL,                    -- Natural language question
    ground_truth_sql TEXT NOT NULL,            -- Expected SQL query
    expected_result JSONB,                      -- Expected query result (optional)
    expected_row_count INT,                     -- Expected number of rows
    category VARCHAR(100),                      -- Test category (e.g., 'aggregation', 'join', 'filter')
    difficulty VARCHAR(20) DEFAULT 'medium',    -- easy, medium, hard
    tenant_id INT,                              -- Tenant-specific test cases
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true,             -- Enable/disable test cases
    notes TEXT                                  -- Additional context or notes
);

-- Index for efficient querying
CREATE INDEX IF NOT EXISTS idx_golden_dataset_category ON public.golden_dataset(category);
CREATE INDEX IF NOT EXISTS idx_golden_dataset_difficulty ON public.golden_dataset(difficulty);
CREATE INDEX IF NOT EXISTS idx_golden_dataset_tenant ON public.golden_dataset(tenant_id);
CREATE INDEX IF NOT EXISTS idx_golden_dataset_active ON public.golden_dataset(is_active) WHERE is_active = true;

-- Evaluation results table
CREATE TABLE IF NOT EXISTS public.evaluation_results (
    evaluation_id SERIAL PRIMARY KEY,
    test_id INT NOT NULL REFERENCES public.golden_dataset(test_id),
    run_timestamp TIMESTAMP DEFAULT NOW(),
    generated_sql TEXT,                        -- SQL generated by agent
    actual_result JSONB,                       -- Actual query result
    actual_row_count INT,                      -- Actual number of rows
    is_correct BOOLEAN,                        -- Functional correctness
    error_message TEXT,                        -- Error if execution failed
    token_count INT,                           -- Total tokens used
    execution_time_ms INT,                     -- Execution time in milliseconds
    trace_id VARCHAR(255),                     -- MLflow trace ID for debugging
    tenant_id INT,
    FOREIGN KEY (test_id) REFERENCES public.golden_dataset(test_id)
);

-- Index for evaluation analysis
CREATE INDEX IF NOT EXISTS idx_eval_results_test_id ON public.evaluation_results(test_id);
CREATE INDEX IF NOT EXISTS idx_eval_results_timestamp ON public.evaluation_results(run_timestamp);
CREATE INDEX IF NOT EXISTS idx_eval_results_correct ON public.evaluation_results(is_correct);

-- Grant permissions
GRANT SELECT, INSERT, UPDATE ON public.golden_dataset TO bi_agent_ro;
GRANT SELECT, INSERT ON public.evaluation_results TO bi_agent_ro;
GRANT USAGE ON SEQUENCE public.golden_dataset_test_id_seq TO bi_agent_ro;
GRANT USAGE ON SEQUENCE public.evaluation_results_evaluation_id_seq TO bi_agent_ro;

-- Add comments
COMMENT ON TABLE public.golden_dataset IS 'Golden test cases for regression testing. Each test case contains a question and expected SQL.';
COMMENT ON TABLE public.evaluation_results IS 'Results from running evaluation suite against golden dataset.';
