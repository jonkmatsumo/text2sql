# ML Hardening Flags Reference (v4)

This document is the operator-facing source of truth for ML-adjacent hardening and containment flags in this repository.

| Flag | Default | Scope | Effect | Where Read | Related Signals | When to Enable |
| --- | --- | --- | --- | --- | --- | --- |
| `SPACY_ENABLED` | `false` | Canonicalization runtime | Enables/disables SpaCy-backed canonicalization pipeline. | `src/mcp_server/services/canonicalization/spacy_pipeline.py` | Canonicalization availability and reload outcomes. | Enable once SpaCy models/patterns are deployed and validated. |
| `PATTERNS_DIR` | unset | Canonicalization runtime | Overrides default pattern directory for entity/dependency patterns. | `src/mcp_server/services/canonicalization/spacy_pipeline.py` | Pattern-load logs, default-pattern fallback warnings. | Enable when using tenant/domain-specific pattern packs. |
| `RAG_EMBEDDING_PROVIDER` | `fastembed` | RAG embeddings | Selects embedding provider (`fastembed`/`mock`). | `src/mcp_server/services/rag/engine.py` | Embedding-load logs and RAG retrieval behavior. | Use `mock` for deterministic tests; keep `fastembed` in production. |
| `AGENT_SCHEMA_DRIFT_HINTS` | `true` | Agent execution guardrail | Controls whether schema drift hints are emitted from execution errors. | `src/agent/nodes/execute.py` | `schema_drift_suspected`, missing-identifier metadata. | Keep enabled unless explicitly suppressing drift hinting noise. |
| `AGENT_SCHEMA_DRIFT_AUTO_REFRESH` | `false` | Agent execution guardrail | Allows schema-refresh retry flow on suspected drift. | `src/agent/nodes/execute.py` | `schema_drift_auto_refresh`, refresh decision events. | Enable when schema churn is common and refresh overhead is acceptable. |
| `AGENT_BLOCK_ON_SCHEMA_MISMATCH` | `false` | Agent execution guardrail | Escalates detected schema mismatch to pre-exec blocking behavior. | `src/agent/nodes/execute.py` | Early block outcomes for mismatch detection. | Enable in stricter environments where stale-schema execution is unacceptable. |
| `AGENT_SCHEMA_BINDING_VALIDATION` | `true` | Validation hardening | Enables schema-binding validation for generated SQL. | `src/agent/nodes/validate.py`, `src/common/config/diagnostics.py` | Validation reports and diagnostics enabled-flags. | Keep enabled by default; disable only for emergency compatibility. |
| `AGENT_SCHEMA_BINDING_SOFT_MODE` | `false` | Validation hardening | Runs schema binding in warn-only style when enabled with validation. | `src/agent/nodes/validate.py`, `src/common/config/diagnostics.py` | Validation warning volume vs hard failures. | Enable for staged rollouts before strict enforcement. |
| `AGENT_COLUMN_ALLOWLIST_MODE` | `warn` | Validation hardening | Column allowlist policy mode (`warn`/`block`/`off`). | `src/agent/nodes/validate.py`, `src/common/config/diagnostics.py` | Column-allowlist violations and enforcement outcomes. | Start at `warn`; move to `block` after allowlist quality is verified. |
| `AGENT_COLUMN_ALLOWLIST_FROM_SCHEMA_CONTEXT` | `true` | Validation hardening | Allows inferred allowlist from schema context when explicit list is absent. | `src/agent/nodes/validate.py`, `src/common/config/diagnostics.py` | Validation fallback behavior and config sanity checks. | Keep enabled unless operating with strict explicit allowlists only. |
| `AGENT_CARTESIAN_JOIN_MODE` | `warn` | Validation hardening | Cartesian join handling mode (`warn`/`block`/`off`). | `src/agent/nodes/validate.py`, `src/common/config/diagnostics.py`, `src/agent/validation/ast_validator.py` | Cartesian risk telemetry and rejection rates. | Use `block` in regulated workloads; use `warn` during rollout. |
| `AGENT_CAPABILITY_FALLBACK_MODE` | `off` | Execution fallback guardrail | Controls fallback behavior for unsupported execution capabilities. | `src/mcp_server/tools/execute_sql_query.py`, `src/common/config/diagnostics.py` | Capability mismatch metadata and fallback markers. | Enable non-`off` only when controlled degradation is preferred to hard failure. |
| `AGENT_PROVIDER_CAP_MITIGATION` | `off` | Provider-cap containment | Mitigation policy when provider truncation caps are detected. | `src/mcp_server/tools/execute_sql_query.py`, `src/common/config/diagnostics.py` | Provider-cap detection metadata and mitigation mode. | Enable in environments with frequent provider-cap truncation. |
| `AGENT_CORRECTION_SIMILARITY_ENFORCE` | `false` | Correction/calibration guardrail | Enables minimum-similarity gating before applying correction candidates. | `src/agent/nodes/correct.py` | Correction acceptance/rejection trends. | Enable when correction safety should be stricter than recall. |
| `AGENT_CORRECTION_SIMILARITY_MIN_SCORE` | `0.5` | Correction/calibration guardrail | Similarity threshold applied when correction-similarity enforcement is on. | `src/agent/nodes/correct.py` | Correction skip/reject rates. | Tune upward to reduce risky corrections; tune downward to recover recall. |
| `ENUM_CARDINALITY_THRESHOLD` | `10` | Pattern-generation calibration | Distinct-value threshold for enum-like column detection. | `src/ingestion/patterns/generator.py`, `src/ui_api_gateway/app.py` | Enum detector candidate volume and precision. | Increase for wider categorical domains; decrease for stricter precision. |
| `ENUM_CARDINALITY_SAMPLE_ROWS` | `10000` | Pattern-generation calibration | Sample size used for enum-like cardinality probing. | `src/ingestion/patterns/generator.py` | Detector runtime and confidence stability. | Raise for higher-confidence detection on large tables. |
| `ENUM_CARDINALITY_QUERY_TIMEOUT_MS` | `2000` | Pattern-generation calibration | Timeout budget for cardinality probe queries. | `src/ingestion/patterns/generator.py` | Probe timeout rates and ingestion latency. | Raise if probes timeout under expected production load. |
| `AGENT_RETRY_POLICY` | `adaptive` | Retry benchmark/control | Selects retry policy mode for correction/timeout handling. | `src/agent/graph.py`, `src/agent/utils/retry.py`, `src/common/config/diagnostics.py` | Retry decision summaries and budget outcomes. | Keep `adaptive` unless testing fixed policy behavior. |
| `AGENT_MAX_RETRIES` | `3` | Retry benchmark/control | Maximum correction retries per run. | `src/agent/graph.py`, `src/common/config/diagnostics.py` | Retry counts, budget exhaustion, timeout incidence. | Increase only when latency budget allows extra correction loops. |
| `SCHEMA_CACHE_TTL_SECONDS` | `3600` | Drift/coverage control | TTL for agent schema snapshot cache entries. | `src/agent/utils/schema_cache.py` | Cache-hit freshness and refresh frequency. | Lower during high schema churn; raise for stable schemas. |
| `DAL_SCHEMA_CACHE_TTL_SECONDS` | `300` | Drift/coverage control | TTL for DAL schema-cache entries. | `src/dal/schema_cache.py` | DAL schema cache freshness and reload pressure. | Lower when backend schemas change frequently. |
| `DAL_SYNC_MAX_ROWS` | `0` (unbounded) | Coverage/containment | Upper bound for sync query row returns at DAL layer. | `src/dal/util/row_limits.py` | Result-size truncation and payload containment metrics. | Set to bound high-cost sync query responses. |
