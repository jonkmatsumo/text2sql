name: Golden Dataset Evaluation

on:
  workflow_dispatch:
    inputs:
      dataset_mode:
        description: "Dataset mode"
        required: true
        default: "synthetic"
        type: choice
        options:
          - synthetic
          - pagila

env:
  DATASET_MODE: ${{ github.event.inputs.dataset_mode || 'synthetic' }}

jobs:
  evaluate:
    name: Run Golden Dataset Evaluation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.5.21"
          enable-cache: true
          cache-suffix: "workspace"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dependencies (uv)
        run: uv sync --frozen

      - name: Run evaluation suite (Golden Only)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATASET_MODE: ${{ env.DATASET_MODE }}
        run: |
          cd agent
          uv run python3 scripts/run_evaluation.py --golden-only --dataset ${{ env.DATASET_MODE }} --run-id ci-run

      - name: Upload evaluation artifacts
        uses: actions/upload-artifact@v6
        with:
          name: evaluation-results
          path: agent/evaluation_artifacts/

      - name: Metrics Gating & Baseline Check
        id: gating
        run: |
          SUMMARY_PATH="agent/evaluation_artifacts/ci-run/summary.json"
          BASELINE_PATH="evaluation/baselines/${{ env.DATASET_MODE }}_baseline.json"

          if [ ! -f "$SUMMARY_PATH" ]; then
            echo "::error::Evaluation summary not found at $SUMMARY_PATH"
            exit 1
          fi

          EM_RATE=$(jq -r '.exact_match_rate' $SUMMARY_PATH)
          AVG_STRUCT=$(jq -r '.avg_structural_score' $SUMMARY_PATH)

          echo "Exact Match Rate: $EM_RATE"
          echo "Avg Structural Score: $AVG_STRUCT"

          # 1. Hard Gating (Static Thresholds)
          if (( $(echo "$EM_RATE < 0.50" | bc -l) )); then
            echo "::error::Exact Match Rate below 50% ($EM_RATE)"
            exit 1
          fi

          if (( $(echo "$EM_RATE < 0.70" | bc -l) )); then
            echo "::warning::Exact Match Rate below 70% ($EM_RATE)"
          fi

          if (( $(echo "$AVG_STRUCT < 0.60" | bc -l) )); then
            echo "::warning::Avg Structural Score below 60% ($AVG_STRUCT)"
          fi

          # 2. Baseline Guard & Regression Check
          if [ -f "$BASELINE_PATH" ]; then
            ESTABLISHED=$(jq -r '.baseline_established // false' $BASELINE_PATH)
            if [ "$ESTABLISHED" = "true" ]; then
              BASE_EM=$(jq -r '.exact_match_rate' $BASELINE_PATH)
              BASE_STRUCT=$(jq -r '.avg_structural_score' $BASELINE_PATH)

              echo "Baseline EM: $BASE_EM"
              echo "Baseline Avg Structural: $BASE_STRUCT"

              # FAIL if exact_match_rate drop > 0.05
              EM_DROP=$(echo "$BASE_EM - $EM_RATE" | bc -l)
              if (( $(echo "$EM_DROP > 0.05" | bc -l) )); then
                echo "::error::Regression detected: EM Rate dropped by $EM_DROP (> 0.05)"
                exit 1
              fi

              # WARN if avg_structural_score drop > 0.10
              STRUCT_DROP=$(echo "$BASE_STRUCT - $AVG_STRUCT" | bc -l)
              if (( $(echo "$STRUCT_DROP > 0.10" | bc -l) )); then
                echo "::warning::Regression detected: Avg Structural Scan dropped by $STRUCT_DROP (> 0.10)"
              fi
            else
              echo "Baseline not established for ${{ env.DATASET_MODE }}, skipping regression check."
            fi
          else
            echo "Baseline file missing at $BASELINE_PATH, skipping regression check."
          fi
